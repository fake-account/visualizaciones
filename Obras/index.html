<!DOCTYPE html>
<html>
  <head>
    <style>
      html, body, #map {
        height: 100%;
        padding: 0;
        margin: 0;
      }
    </style>

    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v2/themes/css/cartodb.css" />
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v2/themes/css/cartodb.ie.css" />
    <![endif]-->

    <link rel="stylesheet/less" href="less/bootstrap.less">

    http://addyosmani.github.com/jquery-ui-bootstrap/bootstrap/bootstrap.css





    <link rel="stylesheet" href="css/style.css" />

    <script src="js/less.js"></script>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />

    

    <link rel="stylesheet" href="http://addyosmani.github.com/jquery-ui-bootstrap/css/custom-theme/jquery-ui-1.8.16.custom.css" />

    <script src="http://code.jquery.com/jquery-1.8.3.js"></script>
    <script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
    <script>less.watch();</script>

  </head>
    
  <body>



<div class="navbar-fixed-top">
  <div class="header-gcba">
    <div class="header-inner">
      <div class="container-fluid">
      <div id="logo"></div>
        <h2 class="slogan">En todo est√°s vos</h2>
      </div>
    </div>
  </div>
</div>



<div id="map"></div>




<div class="navbar navbar-fixed-bottom">
<div class="navbar-inner">
<div class="container-fluid">
<div class="row-fluid">
<div class="span3"><h1 class="brand" href="#">Plan de Obras 2013, GCBA</h1></div>

<div class="span6">

  <div id="slider-range"></div>
  <input type="text" id="datePickerStart" />
  <input type="text" id="datePickerEnd" />



</div>

</div>
  </body>


  <!-- include cartodb.js library -->
  <script src="http://libs.cartocdn.com/cartodb.js/v2/cartodb.js"></script>
  <script>
    var myLayer
    function main() {

      var map = L.map('map', { 
        zoomControl: false,
        center: [-34.618234674892, -58.404178619384766],
        zoom: 12
      })

      // add a nice baselayer from mapbox
      L.tileLayer('http://a.tiles.mapbox.com/v3/pixelbeat.map-pet5vndu/{z}/{x}/{y}.png', {
        attribution: 'MapBox'
      }).addTo(map);

      cartodb.createLayer(map, 'http://gcbadata.cartodb.com/api/v1/viz/16866/viz.json', {
        query: 'select * from {{table_name}}'

      })
       .on('done', function(layer) {
        map.addLayer(layer);
        myLayer = layer;
        setSlider();


        layer.on('featureOver', function(e, pos, latlng, data) {
          cartodb.log.log(e, pos, latlng, data);
        });

        layer.on('error', function(err) {
          cartodb.log.log('error: ' + err);
        });

      }).on('error', function() {
        cartodb.log.log("some error occurred");
      });



    }

    // you could use $(window).load(main);
    window.onload = main;


    function setSlider() {

    var sql = new cartodb.SQL({ user: 'gcbadata' });
      sql.execute("SELECT MIN (START_TS) FROM plan_de_obras")
        .done(function(data) {
          var timeFirst = new Date(Date.parse(data.rows[0].min));
          initSlider(timeFirst)
        })
        .error(function(errors) {
          // errors contains a list of errors
          console.log("error:" + err);
        })

    }

    function updateMap(firstDate, lastDate) {
      sql = "select * from " + myLayer.options.table_name + " where end_ts < '" + lastDate.toUTCString() + "' and start_ts > '" + firstDate.toUTCString() +"'"
          console.log("sql: " +  sql)
          myLayer.setQuery( sql)
    }

    function updatePickers(firstDate, lastDate){
      $( "#datePickerStart" ).datepicker( "setDate", firstDate);
      $( "#datePickerEnd" ).datepicker( "setDate", lastDate);
    }

    function updateSlider(minDate) {
      one_day = 1000*60*60*24
      $("#slider-range").slider("values", 0, Math.ceil((new Date(firstDate) - minDate)/one_day))
      $("#slider-range").slider("values", 1, Math.ceil((new Date(lastDate) - minDate)/one_day))
    }

    function initSlider(minDate, max_days) {
      var one_day = 1000*60*60*24;
      var timeNow = new Date();
      var max_days = Math.ceil((timeNow-minDate)/one_day)
  
      $( "#datePickerStart" ).datepicker({ defaultDate: -max_days, minDate: -max_days, maxDate: 0});
      $( "#datePickerStart" ).datepicker( "setDate", minDate);

      $("#datePickerStart").change(function(eventData) {
        firstDate = $("#datePickerStart").datepicker("getDate");
        lastDate = $("#datePickerEnd").datepicker("getDate")
        updateSlider(minDate, firstDate, lastDate );
        updateMap(firstDate, lastDate);
      });


      $( "#datePickerEnd" ).datepicker({ defaultDate: 0, minDate: -max_days, maxDate: 0});
      $( "#datePickerEnd" ).datepicker( "setDate", timeNow);

      $("#datePickerEnd").change(function(eventData) {
        firstDate = $("#datePickerStart").datepicker("getDate");
        lastDate = $("#datePickerEnd").datepicker("getDate")
        updateSlider(minDate, firstDate, lastDate );
        updateMap(firstDate, lastDate);
      });




      $( "#slider-range" ).slider({
        range: true,
        min: 0,
        max: max_days,
        values: [ 0, max_days ],
        slide: function(event, ui) {
          setMinDate = new Date(minDate.getTime() + ui.values[0]*24*60*60*1000);
          setMaxDate = new Date(minDate.getTime() + ui.values[1]*24*60*60*1000);
          updatePickers(setMinDate, setMaxDate)
        },
        stop: function( event, ui ) {
          setMinDate = new Date(minDate.getTime() + ui.values[0]*24*60*60*1000);
          setMaxDate = new Date(minDate.getTime() + ui.values[1]*24*60*60*1000);
          updateMap(setMinDate, setMaxDate)
        }
      });
      //$("#amount").val( "$" + $( "#slider-range" ).slider( "values", 0 ) + " - $" + $( "#slider-range" ).slider( "values", 1 ) );
    }


  </script>


</html>